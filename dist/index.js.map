{"version":3,"file":"index.js","sourceRoot":"/src/","sources":["index.ts"],"names":[],"mappings":";;;;;;;;;;;AAAA,mCAAmC;AACnC,kCAAkC;AAClC,qCAAoC;AACpC,+BAA2D;AAC3D,2CAAoC;AACpC,4EAAqE;AACrE,2DAAoD;AACpD,2EAAoE;AAEpE,MAAM,EAAC,KAAK,EAAE,IAAI,EAAE,IAAI,EAAC,GAAG,mBAAS,CAAC,EAAE,CAAC,CAAC;AAE1C,MAAM,IAAI,GAAG,UAAI,CAAC,CAAC,CAAC,QAAQ,CAAC,UAAI,EAAE,EAAE,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC;AAE9C,IAAI,eAAS,EAAE;IACb,IAAI,CAAC,iBAAiB,GAAG,eAAS,CAAC,CAAC;CACrC;KAAM;IACL,IAAI,CAAC,0DAA0D,CAAC,CAAC;CAClE;AAED,MAAM,GAAG,GAAG,GAAG,CAAC,GAAG,EAAE,CAAC;AACtB,MAAM,EAAE,GAAG,IAAI,oBAAW,CAAC,GAAG,EAAE;IAC9B,QAAQ,EAAE,eAAS;CACpB,CAAC,CAAC;AAEH,IAAI,WAAW,GAAG,IAAI,qBAAW,CAAC,eAAS,EAAE;IAC3C,QAAQ,EAAE,EAAE;IACZ,gBAAgB,EAAE,CAAC;IACnB,eAAe,EAAE,IAAI;IACrB,kBAAkB,EAAE,IAAI;CACzB,CAAC,CAAC;AAEH,MAAM,KAAK,GAAG,GAAS,EAAE;IACvB,WAAW,GAAG,MAAM,WAAW,CAAC,OAAO,EAAE,CAAC;IAC1C,MAAM,EAAE,GAAG,WAAW,CAAC,EAAE,CAAC,cAAQ,CAAC,CAAC;IACpC,MAAM,WAAW,GAAG,IAAI,qBAAW,CAAC,EAAE,EAAE,EAAE,CAAC,CAAC;IAC5C,WAAW,CAAC,eAAe,CAAC,IAAI,+BAAqB,CAAC,WAAW,CAAC,CAAC,CAAC;IACpE,EAAE,CAAC,YAAY,CAAC,CAAC,MAAM,EAAE,EAAE,CAAC,gCAAsB,CAAC,WAAW,EAAE,MAAM,CAAC,CAAC,CAAC;IACzE,OAAO,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;AACzB,CAAC,CAAA,CAAA;AAED,IAAI,CAAC,cAAc,CAAC,CAAC;AACrB,KAAK,EAAE;KACJ,IAAI,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,oBAAoB,IAAI,EAAE,CAAC,CAAC;KAC5C,KAAK,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC","sourcesContent":["import {UWSProvider} from \"teckos\";\nimport * as uWS from \"teckos/uws\";\nimport {MongoClient} from \"mongodb\";\nimport {MONGO_DB, MONGO_URL, PORT, REDIS_URL} from \"./env\";\nimport useLogger from \"./useLogger\";\nimport handleSocketConnection from \"./socket/handleSocketConnection\";\nimport Distributor from \"./distributor/Distributor\";\nimport MediasoupStageHandler from \"./handler/MediasoupStageHandler\";\n\nconst {error, warn, info} = useLogger(\"\");\n\nconst port = PORT ? parseInt(PORT, 10) : 4000;\n\nif (REDIS_URL) {\n  info(\"Using redis at \" + REDIS_URL);\n} else {\n  warn(\"Not synchronizing via redis - running in standalone mode\");\n}\n\nconst uws = uWS.App();\nconst io = new UWSProvider(uws, {\n  redisUrl: REDIS_URL,\n});\n\nlet mongoClient = new MongoClient(MONGO_URL, {\n  poolSize: 10,\n  bufferMaxEntries: 0,\n  useNewUrlParser: true,\n  useUnifiedTopology: true,\n});\n\nconst start = async () => {\n  mongoClient = await mongoClient.connect();\n  const db = mongoClient.db(MONGO_DB);\n  const distributor = new Distributor(io, db);\n  distributor.addStageHandler(new MediasoupStageHandler(distributor));\n  io.onConnection((socket) => handleSocketConnection(distributor, socket));\n  return io.listen(port);\n}\n\ninfo(\"Starting ...\");\nstart()\n  .then(() => info(`Listening on port${port}`))\n  .catch((e) => error(e));\n"]}